name: "IT test workflow"

on:
    pull_request:
        branches: [ master, stable-* ]

jobs:
    qa:
        runs-on: macos-latest
        steps:
            -   uses: actions/checkout@v2
            -   name: setup-docker
                uses: docker-practice/actions-setup-docker@1.0.8
            -   name: Build server
                run: docker build -f scripts/Dockerfile -t nextcloud-android-ci:${{github.event.number}}
            -   name: Run server
                run: docker run --rm -d nextcloud-android-ci:${{github.event.number}} -p 80:80
            -   name: Check if secrets are available
                run: echo "::set-output name=ok::${{ secrets.KS_PASS != '' }}"
                id: check-secrets
            -   uses: actions/checkout@v2
                if: ${{ steps.check-secrets.outputs.ok == 'true' }}
            -   name: Set up JDK 11
                if: ${{ steps.check-secrets.outputs.ok == 'true' }}
                uses: actions/setup-java@v2
                with:
                    distribution: "adopt"
                    java-version: 11
            -   name: Build gplay
                run: |
                    mkdir -p $HOME/.gradle
                    echo "org.gradle.jvmargs=-Xmx2g -XX:MaxMetaspaceSize=512m -XX:+HeapDumpOnOutOfMemoryError" > $HOME/.gradle/gradle.properties
                    ./gradlew assembleGplayDebug
            -   name: Wait for server
                run: ./scripts/wait_for_server.sh "127.0.0.1"
            -   name: Run integration tests
                uses: reactivecircus/android-emulator-runner@v2
                with:
                    api-level: 27
                    emulator-options: -no-window -gpu swiftshader_indirect -no-snapshot -noaudio -no-boot-anim -skin 500x833
                    script: ./gradlew connectedGplayDebugAndroidTest -Pandroid.testInstrumentationRunnerArguments.notAnnotation=com.owncloud.android.utils.ScreenshotTest -Pandroid.testInstrumentationRunnerArguments.TEST_SERVER_URL=http://10.0.2.2

